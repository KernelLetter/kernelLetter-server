# 카카오 로그인 구현 가이드

## 목차
1. [개요](#개요)
2. [전체 흐름도](#전체-흐름도)
3. [설정 파일](#설정-파일)
4. [DTO 클래스](#dto-클래스)
5. [Service 클래스](#service-클래스)
6. [Controller 클래스](#controller-클래스)
7. [API 엔드포인트 사용법](#api-엔드포인트-사용법)

---

## 개요

이 가이드는 **카카오 OAuth 2.0 로그인**과 **세션 기반 인증**을 구현하는 방법을 설명합니다.

### 주요 기능
1. **처음 로그인**: 카카오 로그인 후 → 추가 정보 입력 (이름, 알림받을 이메일)
2. **이후 로그인**: 카카오 로그인만 하면 자동으로 로그인 완료
3. **세션 관리**: 로그인 상태를 세션에 저장하여 유지

---

## 전체 흐름도

```
[프론트엔드]                    [백엔드]                      [카카오 서버]
     |                             |                              |
     |-- 1. 카카오 로그인 버튼 클릭 -->                            |
     |                             |-- 2. 인가코드 요청 ---------->|
     |<-------------------------- 3. 인가코드 반환 ----------------|
     |-- 4. /auth/kakao/callback -->|                              |
     |    (code 파라미터)            |                              |
     |                             |-- 5. Access Token 요청 ----->|
     |                             |<-- 6. Access Token 반환 -----|
     |                             |-- 7. 사용자 정보 요청 ------->|
     |                             |<-- 8. 사용자 정보 반환 ------|
     |                             |                              |
     |                             |-- 9. DB에서 사용자 조회       |
     |                             |                              |
     |                        [처음 로그인?]                       |
     |                         Yes  |  No                         |
     |<-- 10a. firstLogin=true ---|  |                            |
     |    (추가 정보 입력 필요)        |  |                            |
     |                             |  |-- 10b. 세션 생성 & 로그인 완료
     |-- 11. /api/user/register -->|  |                            |
     |    (name, email)            |  |                            |
     |                             |<-|                            |
     |<-- 12. 등록 완료 & 세션 생성 --|                              |
```

---

## 설정 파일

### 1. `application.yml` (기본 설정)

```yaml
spring:
  application:
    name: kernelLetter

  config:
    import: "optional:classpath:application-secret.yml"

  # 세션 설정 (추가 필요)
  session:
    store-type: none  # 기본 메모리 세션 사용 (운영에서는 Redis 권장)
    timeout: 1800     # 세션 타임아웃 30분 (초 단위)

  # JPA 설정 (기존에 있다면 유지)
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
```

### 2. `application-secret.yml` (민감 정보 - Git에 올리지 않음)

```yaml
# 카카오 OAuth 설정
kakao:
  client-id: YOUR_KAKAO_REST_API_KEY           # 카카오 개발자 콘솔에서 발급받은 REST API 키
  client-secret: YOUR_KAKAO_CLIENT_SECRET      # 카카오 개발자 콘솔에서 발급받은 Client Secret
  redirect-uri: http://localhost:8080/auth/kakao/callback  # 카카오 로그인 후 리다이렉트될 URI
```

**설정 설명:**
- `client-id`: 카카오 개발자 콘솔에서 앱을 만들면 발급받는 REST API 키
- `client-secret`: 보안을 위한 추가 키 (앱 설정에서 활성화 후 발급)
- `redirect-uri`: 카카오 로그인 완료 후 돌아올 백엔드 주소 (카카오 콘솔에 등록 필요)

---

## DTO 클래스

### 1. `SessionUser.java` (세션에 저장할 사용자 정보)

**위치:** `src/main/java/com/kernelLetter/dto/SessionUser.java`

```java
package com.kernelLetter.dto;

import com.kernelLetter.domain.entity.User;
import lombok.Getter;
import java.io.Serializable;

/**
 * 세션에 저장될 사용자 정보를 담는 DTO
 *
 * Serializable을 구현해야 세션에 저장 가능
 * (세션을 Redis 등 외부 저장소에 저장할 때 직렬화가 필요함)
 */
@Getter
public class SessionUser implements Serializable {

    // 직렬화 버전 ID (클래스 변경 시 호환성 관리)
    private static final long serialVersionUID = 1L;

    // 사용자 DB ID
    private Long id;

    // 카카오에서 부여한 고유 ID
    private String kakaoId;

    // 사용자 이름
    private String name;

    // 알림받을 이메일 주소
    private String email;

    // 카카오 계정 이메일
    private String kakaoEmail;

    /**
     * User 엔티티로부터 SessionUser 생성
     *
     * @param user DB에서 조회한 User 엔티티
     */
    public SessionUser(User user) {
        this.id = user.getId();
        this.kakaoId = user.getKakaoId();
        this.name = user.getName();
        this.email = user.getEmail();
        this.kakaoEmail = user.getKakaoEmail();
    }
}
```

**주요 포인트:**
- `Serializable`: 세션에 객체를 저장하려면 반드시 구현해야 함
- **Entity를 직접 세션에 저장하지 않는 이유**: Entity는 JPA가 관리하므로 직렬화 시 문제 발생 가능
- 필요한 정보만 담아서 가볍게 유지

---

### 2. `UserRegisterDTO.java` (추가 정보 입력 DTO)

**위치:** `src/main/java/com/kernelLetter/dto/UserRegisterDTO.java`

```java
package com.kernelLetter.dto;

import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;

/**
 * 처음 로그인한 사용자가 추가 정보를 입력할 때 사용하는 DTO
 */
@Getter
@NoArgsConstructor  // 기본 생성자 (JSON 파싱에 필요)
@AllArgsConstructor // 모든 필드를 받는 생성자
public class UserRegisterDTO {

    // 사용자 이름
    private String name;

    // 알림받을 이메일 주소
    private String email;
}
```

**사용 시점:**
- 프론트엔드에서 첫 로그인 후 추가 정보 입력 폼을 보여줌
- 사용자가 이름과 이메일을 입력하면 이 DTO로 전송

---

## Service 클래스

### 1. `KakaoTokenProvider.java` (Access Token 발급)

**위치:** `src/main/java/com/kernelLetter/service/KakaoTokenProvider.java`

```java
package com.kernelLetter.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.kernelLetter.dto.response.KakaoTokenResponse;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Component;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.client.RestTemplate;

/**
 * 카카오 인가코드를 Access Token으로 교환하는 컴포넌트
 */
@Component
public class KakaoTokenProvider {

    // application-secret.yml에서 주입받는 카카오 설정값들
    @Value("${kakao.client-id}")
    private String clientId;

    @Value("${kakao.redirect-uri}")
    private String redirectUri;

    @Value("${kakao.client-secret}")
    private String clientSecret;

    /**
     * 카카오 인가코드를 Access Token으로 교환
     *
     * @param code 카카오 로그인 후 받은 인가코드
     * @return Access Token 문자열
     */
    public String getAccessToken(String code) {
        // HTTP 요청을 보내기 위한 RestTemplate 생성
        RestTemplate restTemplate = new RestTemplate();

        // 카카오 토큰 발급 API 엔드포인트
        // 주의: kauth.kakao.com (기존 kakao.com은 잘못된 주소)
        String tokenUrl = "https://kauth.kakao.com/oauth/token";

        // 요청 파라미터 준비 (폼 데이터 형식)
        MultiValueMap<String, String> params = new LinkedMultiValueMap<>();
        params.add("grant_type", "authorization_code");  // OAuth 2.0 인가 코드 방식
        params.add("client_id", clientId);               // REST API 키
        params.add("client_secret", clientSecret);       // 클라이언트 시크릿
        params.add("redirect_uri", redirectUri);         // 등록한 리다이렉트 URI
        params.add("code", code);                        // 카카오에서 받은 인가 코드

        // HTTP 헤더 설정
        HttpHeaders headers = new HttpHeaders();
        // Content-Type을 application/x-www-form-urlencoded로 설정
        // (폼 데이터 형식으로 전송)
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);

        // 요청 객체 생성 (헤더 + 바디)
        HttpEntity<MultiValueMap<String, String>> request = new HttpEntity<>(params, headers);

        // POST 요청 전송 및 응답 받기
        ResponseEntity<KakaoTokenResponse> response = restTemplate.postForEntity(
            tokenUrl,
            request,
            KakaoTokenResponse.class  // 응답을 KakaoTokenResponse로 자동 변환
        );

        // 응답에서 access_token 추출하여 반환
        if (response.getBody() != null) {
            return response.getBody().getAccess_token();
        } else {
            throw new RuntimeException("카카오 토큰 발급 실패: 응답이 비어있습니다.");
        }
    }
}
```

**주요 흐름:**
1. 인가코드 + 클라이언트 정보를 카카오 서버에 전송
2. 카카오가 검증 후 Access Token 발급
3. Access Token을 반환 (이걸로 사용자 정보 조회 가능)

---

### 2. `KakaoUserInfoProvider.java` (사용자 정보 조회)

**위치:** `src/main/java/com/kernelLetter/service/KakaoUserInfoProvider.java`

```java
package com.kernelLetter.service;

import com.kernelLetter.dto.KakaoUserInfoDTO;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;

import java.util.Map;

/**
 * 카카오 Access Token으로 사용자 정보를 조회하는 컴포넌트
 */
@Component
public class KakaoUserInfoProvider {

    /**
     * Access Token을 사용하여 카카오 사용자 정보 조회
     *
     * @param accessToken 카카오 Access Token
     * @return 카카오 사용자 정보 DTO
     */
    public KakaoUserInfoDTO getKakaoUserInfo(String accessToken) {
        RestTemplate restTemplate = new RestTemplate();

        // 카카오 사용자 정보 조회 API 엔드포인트
        String url = "https://kapi.kakao.com/v2/user/me";

        // HTTP 헤더 설정
        HttpHeaders headers = new HttpHeaders();
        // Authorization 헤더에 Bearer 토큰 형식으로 Access Token 추가
        headers.add("Authorization", "Bearer " + accessToken);
        // 응답 형식을 JSON으로 지정
        headers.add("Content-type", "application/x-www-form-urlencoded;charset=utf-8");

        // 요청 객체 생성 (헤더만 있고 바디는 없음)
        HttpEntity<String> request = new HttpEntity<>(headers);

        // GET 요청 전송
        ResponseEntity<Map> response = restTemplate.exchange(
            url,
            HttpMethod.GET,
            request,
            Map.class  // 응답을 Map으로 받음 (JSON 구조가 복잡하므로)
        );

        // 응답 데이터 파싱
        Map<String, Object> responseBody = response.getBody();

        if (responseBody == null) {
            throw new RuntimeException("카카오 사용자 정보 조회 실패: 응답이 비어있습니다.");
        }

        // 카카오 고유 ID 추출 (Long 타입)
        String kakaoId = String.valueOf(responseBody.get("id"));

        // 카카오 계정 정보 추출
        Map<String, Object> kakaoAccount = (Map<String, Object>) responseBody.get("kakao_account");

        // 이메일 정보 추출 (없을 수도 있음)
        String kakaoEmail = kakaoAccount != null ?
                            (String) kakaoAccount.get("email") : null;

        // DTO 생성 및 반환
        return KakaoUserInfoDTO.builder()
                .kakaoId(kakaoId)
                .kakaoEmail(kakaoEmail)
                .build();
    }
}
```

**카카오 API 응답 구조 예시:**
```json
{
  "id": 123456789,
  "kakao_account": {
    "email": "user@example.com",
    "profile": {
      "nickname": "홍길동"
    }
  }
}
```

---

### 3. `KakaoAuthService.java` (로그인 로직 통합)

**위치:** `src/main/java/com/kernelLetter/service/KakaoAuthService.java`

```java
package com.kernelLetter.service;

import com.kernelLetter.domain.entity.User;
import com.kernelLetter.dto.KakaoUserInfoDTO;
import com.kernelLetter.dto.LoginResultDTO;
import com.kernelLetter.dto.SessionUser;
import com.kernelLetter.repository.UserRepository;
import jakarta.servlet.http.HttpSession;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Optional;

/**
 * 카카오 로그인 전체 프로세스를 관리하는 서비스
 */
@Service
@RequiredArgsConstructor  // final 필드에 대한 생성자 자동 생성
public class KakaoAuthService {

    // 의존성 주입 (생성자 주입 방식)
    private final UserRepository userRepository;
    private final KakaoTokenProvider kakaoTokenProvider;
    private final KakaoUserInfoProvider kakaoUserInfoProvider;
    private final HttpSession httpSession;

    /**
     * 1단계: 인가코드로 Access Token 요청
     *
     * @param code 카카오 인가코드
     * @return Access Token
     */
    public String requestAccessToken(String code) {
        return kakaoTokenProvider.getAccessToken(code);
    }

    /**
     * 2단계: Access Token으로 사용자 정보 조회
     *
     * @param accessToken 카카오 Access Token
     * @return 카카오 사용자 정보
     */
    public KakaoUserInfoDTO requestUserInfo(String accessToken) {
        return kakaoUserInfoProvider.getKakaoUserInfo(accessToken);
    }

    /**
     * 3단계: 로그인 처리 (회원가입 또는 로그인)
     *
     * @param kakaoUserInfo 카카오에서 받아온 사용자 정보
     * @return 로그인 결과 (첫 로그인 여부 포함)
     */
    @Transactional  // DB 작업이므로 트랜잭션 처리
    public LoginResultDTO processLogin(KakaoUserInfoDTO kakaoUserInfo) {

        // DB에서 카카오 ID로 사용자 검색
        Optional<User> existingUser = userRepository.findByKakaoId(kakaoUserInfo.getKakaoId());

        // 이미 가입된 사용자인 경우
        if (existingUser.isPresent()) {
            User user = existingUser.get();

            // 첫 로그인 여부 확인
            if (user.isFirstLogin()) {
                // 첫 로그인이면 추가 정보 입력 필요
                // 세션에는 임시로 카카오 정보만 저장
                httpSession.setAttribute("tempKakaoId", kakaoUserInfo.getKakaoId());
                return LoginResultDTO.firstLogin();
            } else {
                // 이미 추가 정보를 입력한 사용자
                // 세션에 사용자 정보 저장
                SessionUser sessionUser = new SessionUser(user);
                httpSession.setAttribute("user", sessionUser);
                return LoginResultDTO.normalLogin(user);
            }
        } else {
            // 처음 가입하는 사용자 → DB에 저장
            User newUser = User.builder()
                    .kakaoId(kakaoUserInfo.getKakaoId())
                    .kakaoEmail(kakaoUserInfo.getKakaoEmail())
                    .isFirstLogin(true)  // 첫 로그인 플래그 설정
                    .build();

            userRepository.save(newUser);

            // 세션에 임시로 카카오 ID 저장 (추가 정보 입력 대기)
            httpSession.setAttribute("tempKakaoId", kakaoUserInfo.getKakaoId());

            return LoginResultDTO.firstLogin();
        }
    }

    /**
     * 4단계: 추가 정보 입력 처리 (처음 로그인 시)
     *
     * @param name 사용자 이름
     * @param email 알림받을 이메일
     */
    @Transactional
    public void registerAdditionalInfo(String name, String email) {

        // 세션에서 임시 저장한 카카오 ID 가져오기
        String tempKakaoId = (String) httpSession.getAttribute("tempKakaoId");

        if (tempKakaoId == null) {
            throw new IllegalStateException("세션에 카카오 정보가 없습니다. 다시 로그인해주세요.");
        }

        // DB에서 사용자 조회
        User user = userRepository.findByKakaoId(tempKakaoId)
                .orElseThrow(() -> new IllegalArgumentException("사용자를 찾을 수 없습니다."));

        // 추가 정보 업데이트 (isFirstLogin도 false로 변경됨)
        user.updateEmail(name, email);

        // JPA가 자동으로 변경 감지하여 DB 업데이트 (dirty checking)

        // 세션에 정식 사용자 정보 저장
        SessionUser sessionUser = new SessionUser(user);
        httpSession.setAttribute("user", sessionUser);

        // 임시 카카오 ID는 제거
        httpSession.removeAttribute("tempKakaoId");
    }

    /**
     * 로그아웃 처리
     */
    public void logout() {
        // 세션 무효화 (모든 세션 데이터 삭제)
        httpSession.invalidate();
    }

    /**
     * 현재 로그인한 사용자 정보 조회
     *
     * @return 세션에 저장된 사용자 정보 (없으면 null)
     */
    public SessionUser getCurrentUser() {
        return (SessionUser) httpSession.getAttribute("user");
    }
}
```

**주요 메소드 설명:**
- `processLogin()`: 카카오 정보로 로그인 처리 (첫 로그인/일반 로그인 구분)
- `registerAdditionalInfo()`: 첫 로그인 시 추가 정보 입력
- `logout()`: 세션 무효화
- `getCurrentUser()`: 현재 로그인 사용자 조회

---

## Controller 클래스

### `KakaoAuthController.java` (REST API 엔드포인트)

**위치:** `src/main/java/com/kernelLetter/controller/Kakao/KakaoAuthController.java`

```java
package com.kernelLetter.controller.Kakao;

import com.kernelLetter.dto.KakaoUserInfoDTO;
import com.kernelLetter.dto.LoginResultDTO;
import com.kernelLetter.dto.SessionUser;
import com.kernelLetter.dto.UserRegisterDTO;
import com.kernelLetter.service.KakaoAuthService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

/**
 * 카카오 로그인 관련 REST API 컨트롤러
 */
@RestController
@RequiredArgsConstructor
public class KakaoAuthController {

    private final KakaoAuthService kakaoAuthService;

    /**
     * 카카오 로그인 콜백 엔드포인트
     *
     * 카카오 로그인 완료 후 리다이렉트되는 주소
     *
     * @param code 카카오에서 발급한 인가코드
     * @return 로그인 결과 (firstLogin 여부, 메시지 등)
     */
    @GetMapping("/auth/kakao/callback")
    public ResponseEntity<LoginResultDTO> kakaoCallback(@RequestParam("code") String code) {

        // 1. 인가코드로 Access Token 발급
        String accessToken = kakaoAuthService.requestAccessToken(code);

        // 2. Access Token으로 사용자 정보 조회
        KakaoUserInfoDTO kakaoUserInfo = kakaoAuthService.requestUserInfo(accessToken);

        // 3. 로그인 처리 (회원가입 또는 기존 사용자 로그인)
        LoginResultDTO result = kakaoAuthService.processLogin(kakaoUserInfo);

        // 4. 결과 반환
        return ResponseEntity.ok(result);
    }

    /**
     * 추가 정보 입력 엔드포인트 (첫 로그인 시)
     *
     * 프론트엔드에서 이름과 이메일을 입력받아 전송
     *
     * @param registerDTO 이름, 이메일 정보
     * @return 등록 완료 메시지
     */
    @PostMapping("/api/user/register")
    public ResponseEntity<String> registerAdditionalInfo(@RequestBody UserRegisterDTO registerDTO) {

        // 추가 정보 등록 및 세션 생성
        kakaoAuthService.registerAdditionalInfo(registerDTO.getName(), registerDTO.getEmail());

        return ResponseEntity.ok("등록이 완료되었습니다.");
    }

    /**
     * 로그아웃 엔드포인트
     *
     * @return 로그아웃 완료 메시지
     */
    @PostMapping("/api/user/logout")
    public ResponseEntity<String> logout() {
        kakaoAuthService.logout();
        return ResponseEntity.ok("로그아웃되었습니다.");
    }

    /**
     * 현재 로그인 사용자 정보 조회
     *
     * @return 세션에 저장된 사용자 정보
     */
    @GetMapping("/api/user/me")
    public ResponseEntity<?> getCurrentUser() {
        SessionUser currentUser = kakaoAuthService.getCurrentUser();

        if (currentUser == null) {
            return ResponseEntity.status(401).body("로그인이 필요합니다.");
        }

        return ResponseEntity.ok(currentUser);
    }
}
```

**API 엔드포인트 정리:**
1. `GET /auth/kakao/callback`: 카카오 로그인 콜백 (자동 호출됨)
2. `POST /api/user/register`: 추가 정보 입력 (첫 로그인 시)
3. `POST /api/user/logout`: 로그아웃
4. `GET /api/user/me`: 현재 로그인 사용자 정보 조회

---

## API 엔드포인트 사용법

### 1. 카카오 로그인 시작 (프론트엔드)

```javascript
// 카카오 로그인 버튼 클릭 시
function loginWithKakao() {
    const clientId = 'YOUR_KAKAO_REST_API_KEY';
    const redirectUri = 'http://localhost:8080/auth/kakao/callback';

    // 카카오 인가 코드 요청 URL로 이동
    window.location.href = `https://kauth.kakao.com/oauth/authorize?response_type=code&client_id=${clientId}&redirect_uri=${redirectUri}`;
}
```

### 2. 카카오 로그인 콜백 처리 (백엔드 자동 처리)

```
GET /auth/kakao/callback?code=AUTHORIZATION_CODE
```

**응답 예시:**

**첫 로그인:**
```json
{
  "firstLogin": true,
  "message": "추가 정보 입력 필요",
  "user": null
}
```

**일반 로그인:**
```json
{
  "firstLogin": false,
  "message": "로그인 성공",
  "user": {
    "id": 1,
    "kakaoId": "123456789",
    "name": "홍길동",
    "email": "user@example.com",
    "kakaoEmail": "kakao@example.com"
  }
}
```

### 3. 추가 정보 입력 (첫 로그인 시)

```
POST /api/user/register
Content-Type: application/json

{
  "name": "홍길동",
  "email": "user@example.com"
}
```

**프론트엔드 예시:**
```javascript
async function registerAdditionalInfo(name, email) {
    const response = await fetch('/api/user/register', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name, email })
    });

    if (response.ok) {
        alert('등록 완료!');
        // 메인 페이지로 이동
        window.location.href = '/';
    }
}
```

### 4. 현재 사용자 정보 조회

```
GET /api/user/me
```

**응답 예시:**
```json
{
  "id": 1,
  "kakaoId": "123456789",
  "name": "홍길동",
  "email": "user@example.com",
  "kakaoEmail": "kakao@example.com"
}
```

### 5. 로그아웃

```
POST /api/user/logout
```

**프론트엔드 예시:**
```javascript
async function logout() {
    await fetch('/api/user/logout', { method: 'POST' });
    alert('로그아웃되었습니다.');
    window.location.href = '/';
}
```

---

## 추가 설정 및 주의사항

### 1. 카카오 개발자 콘솔 설정

1. [카카오 개발자 콘솔](https://developers.kakao.com/) 접속
2. 애플리케이션 생성
3. **앱 설정 > 앱 키**: REST API 키 확인 (`client-id`)
4. **앱 설정 > 보안**: Client Secret 활성화 및 발급 (`client-secret`)
5. **제품 설정 > 카카오 로그인**:
   - 활성화 설정 ON
   - Redirect URI 등록: `http://localhost:8080/auth/kakao/callback`
6. **제품 설정 > 카카오 로그인 > 동의 항목**:
   - 이메일 수집: 필수 또는 선택 동의로 설정

### 2. CORS 설정 (프론트엔드가 다른 포트일 경우)

`SecurityConfig.java`에 CORS 설정 추가:

```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .cors(cors -> cors.configurationSource(corsConfigurationSource()))  // CORS 설정 추가
        .authorizeHttpRequests(auth -> auth.anyRequest().permitAll())
        .csrf(AbstractHttpConfigurer::disable);

    return http.build();
}

@Bean
public CorsConfigurationSource corsConfigurationSource() {
    CorsConfiguration configuration = new CorsConfiguration();
    configuration.addAllowedOrigin("http://localhost:3000");  // 프론트엔드 주소
    configuration.addAllowedMethod("*");
    configuration.addAllowedHeader("*");
    configuration.setAllowCredentials(true);  // 세션 쿠키 전송 허용

    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
    source.registerCorsConfiguration("/**", configuration);
    return source;
}
```

### 3. 세션 쿠키 설정 (프론트엔드가 다른 도메인일 경우)

`application.yml`에 추가:

```yaml
server:
  servlet:
    session:
      cookie:
        same-site: none  # 크로스 도메인 세션 허용
        secure: true     # HTTPS에서만 전송 (운영 환경)
```

### 4. 운영 환경 세션 관리 (Redis 사용 권장)

**build.gradle에 의존성 추가:**
```gradle
implementation 'org.springframework.boot:spring-boot-starter-data-redis'
implementation 'org.springframework.session:spring-session-data-redis'
```

**application.yml 수정:**
```yaml
spring:
  session:
    store-type: redis
  redis:
    host: localhost
    port: 6379
```

---

## 전체 동작 흐름 요약

### 처음 로그인하는 사용자

1. 프론트엔드: 카카오 로그인 버튼 클릭
2. 카카오: 인가 코드 발급
3. 백엔드: `/auth/kakao/callback` 호출됨
4. 백엔드: Access Token 발급 → 사용자 정보 조회
5. 백엔드: DB 조회 → 없음 → 새로 저장 (isFirstLogin=true)
6. 백엔드: `firstLogin: true` 응답
7. 프론트엔드: 추가 정보 입력 폼 표시
8. 사용자: 이름, 이메일 입력
9. 프론트엔드: `/api/user/register` POST 요청
10. 백엔드: 추가 정보 저장 & 세션 생성
11. 로그인 완료!

### 이미 가입한 사용자

1. 프론트엔드: 카카오 로그인 버튼 클릭
2. 카카오: 인가 코드 발급
3. 백엔드: `/auth/kakao/callback` 호출됨
4. 백엔드: Access Token 발급 → 사용자 정보 조회
5. 백엔드: DB 조회 → 있음 → `isFirstLogin` 확인 → false
6. 백엔드: 세션 생성 & `firstLogin: false` 응답
7. 로그인 완료!

---

## 테스트 방법

### 1. 로컬 환경 실행

```bash
# 백엔드 실행
./gradlew bootRun
```

### 2. 브라우저에서 테스트

```
http://localhost:8080/auth/kakao/callback?code=TEST_CODE
```
(실제로는 카카오 로그인 버튼을 통해 자동으로 이동됨)

### 3. 세션 확인

```javascript
// 브라우저 콘솔에서 실행
fetch('/api/user/me')
    .then(res => res.json())
    .then(data => console.log(data));
```

---

## 문제 해결 가이드

### 1. "카카오 토큰 발급 실패" 에러

- `application-secret.yml`의 `client-id`, `client-secret`, `redirect-uri` 확인
- 카카오 개발자 콘솔에서 Redirect URI가 정확히 등록되었는지 확인

### 2. "사용자 정보 조회 실패" 에러

- 카카오 개발자 콘솔에서 이메일 동의 항목이 활성화되었는지 확인

### 3. 세션이 유지되지 않는 문제

- CORS 설정에서 `allowCredentials: true` 확인
- 프론트엔드 요청에 `credentials: 'include'` 옵션 추가

### 4. 첫 로그인 후 추가 정보 입력이 안 됨

- 세션에 `tempKakaoId`가 저장되었는지 확인
- 세션 타임아웃 시간 확인 (기본 30분)

---

## 마무리

이 가이드는 **카카오 OAuth 2.0 로그인**과 **세션 기반 인증**을 구현하는 완전한 코드와 설명을 제공합니다.

**핵심 포인트:**
- 첫 로그인 시 추가 정보 입력 필요
- 세션을 사용하여 로그인 상태 유지
- REST API 방식으로 프론트엔드와 통신

**다음 단계:**
- 운영 환경에서는 Redis를 사용한 세션 관리 권장
- JWT 토큰 방식으로 전환 고려 (무상태 인증)
- 리프레시 토큰 도입 (장기 로그인 유지)

궁금한 점이 있으면 언제든지 질문하세요!